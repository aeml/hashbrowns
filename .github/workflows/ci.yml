name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} • ${{ matrix.compiler }} • ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build_type: [Debug, Release]
        compiler: [default]
        include:
          - os: ubuntu-latest
            build_type: Debug
            compiler: gcc
          - os: ubuntu-latest
            build_type: Release
            compiler: gcc
          - os: ubuntu-latest
            build_type: Debug
            compiler: clang
          - os: ubuntu-latest
            build_type: Release
            compiler: clang

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-
            ccache-${{ runner.os }}-

      - name: Set up compiler (Linux)
        if: runner.os == 'Linux'
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            sudo apt-get update
            sudo apt-get install -y clang ccache
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          else
            sudo apt-get update
            sudo apt-get install -y g++ ccache
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          fi
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV

      - name: Set up ccache (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update || true
          brew install ccache || true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV

      - name: ccache stats (pre)
        run: ccache -s || true

      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: cmake -S . -B build -G "Visual Studio 17 2022" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: cmake --build build --config ${{ matrix.build_type }} -- -j2

      - name: ccache stats (post)
        run: ccache -s || true

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build build --config ${{ matrix.build_type }} -- /m:2

      - name: Run tests
        run: |
          ctest --test-dir build --output-on-failure -C ${{ matrix.build_type }}

      - name: Smoke run (Linux Release only)
        if: matrix.build_type == 'Release' && runner.os == 'Linux'
        run: |
          ./build/hashbrowns --size 1024 --runs 2 --structures array,slist,hashmap --output build/ci_bench.csv || true
      - name: Optional regression check (Linux Release only)
        if: matrix.build_type == 'Release' && runner.os == 'Linux' && hashFiles('docs/baselines/benchmark_results.csv') != ''
        run: |
          ./build/regression_check --current build/ci_bench.csv --baseline docs/baselines/benchmark_results.csv --threshold 10

  perf-guard:
    name: Linux • perf guard
    runs-on: ubuntu-latest
    # Run on pushes to main and PRs, but only gate (fail) when PR has 'perf' label
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'perf')
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y cmake clang-format ccache
      - name: Build Release
        run: |
          bash scripts/build.sh -t Release
      - name: Perf guard
        env:
          TOL_PCT_INSERT: 25
          TOL_PCT_SEARCH: 25
          TOL_PCT_REMOVE: 25
        # Non-blocking except when this is a PR explicitly labeled 'perf'
        continue-on-error: ${{ github.event_name != 'pull_request' || ! contains(github.event.pull_request.labels.*.name, 'perf') }}
        run: |
          bash scripts/perf_guard.sh
      - name: Upload perf guard artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-guard-${{ github.run_id }}
          path: |
            build/perf_guard_current.json
            perf_baselines/baseline.json
          if-no-files-found: ignore
          retention-days: 7
  asan-ubsan:
    name: Linux • clang • ASAN/UBSAN
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
      - name: Configure (ASAN/UBSAN)
        run: |
          cmake -S . -B build-asan \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS_DEBUG="-g -O0 -Wall -Wextra -Wpedantic -fsanitize=address,undefined -fno-omit-frame-pointer"
      - name: Build
        run: cmake --build build-asan -- -j2
      - name: Run unit tests under sanitizers
        env:
          ASAN_OPTIONS: detect_leaks=1:allocator_may_return_null=1
          UBSAN_OPTIONS: print_stacktrace=1
        run: |
          ctest --test-dir build-asan --output-on-failure

  # Optional small benchmark artifact job (Linux only)
  small-benchmarks:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure + Build (Release)
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -- -j2
      - name: Run tiny benchmarks
        run: |
          ./build/hashbrowns --size 2048 --runs 3 --structures array,slist,hashmap --output build/benchmark_results.csv || true
          ./build/hashbrowns --crossover-analysis --max-size 8192 --runs 2 --structures array,slist,hashmap --output build/crossover_results.csv || true
      - name: Optional regression check (if baseline present)
        if: hashFiles('docs/baselines/benchmark_results.csv') != ''
        run: |
          ./build/regression_check --current build/benchmark_results.csv --baseline docs/baselines/benchmark_results.csv --threshold 10
      - name: Upload CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-csvs
          path: |
            build/benchmark_results.csv
            build/crossover_results.csv
  coverage:
    name: Linux • coverage (gcov/lcov)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-coverage-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ccache-coverage-${{ runner.os }}-
      - name: Install build & coverage deps
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ cmake lcov ccache
      - name: Configure (Debug + coverage flags)
        run: |
          cmake -S . -B build-coverage \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-O0 -g --coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_C_FLAGS="-O0 -g --coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
      - name: Build
        run: cmake --build build-coverage -- -j2
      - name: Run tests (coverage)
        run: ctest --test-dir build-coverage --output-on-failure
      - name: Capture coverage (lcov)
        run: |
          lcov --capture --directory build-coverage --output-file coverage.info
          # On some runners, certain exclude patterns may not match any file.
          # "lcov" treats that as an error by default; allow unused patterns so the step doesn't fail.
          lcov --remove coverage.info '/usr/*' '*/tests/*' '*/CMakeFiles/*' --ignore-errors unused --output-file coverage.filtered.info
          lcov --summary coverage.filtered.info
      - name: Generate HTML report
        run: |
          genhtml coverage.filtered.info --output-directory coverage_html --title "hashbrowns Coverage" --legend --show-details
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.info
            coverage.filtered.info
            coverage_html/
          retention-days: 7
